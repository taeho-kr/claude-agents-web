# Error Recovery Procedures (에러 복구 절차)

에이전트 실패 유형별 구체적 복구 절차를 정의합니다.

---

## 실패 유형 분류

### Type A: 빌드/컴파일 에러
```
감지: Bash 실행 결과에 에러 코드 반환
증상: TypeScript 타입 에러, import 누락, 문법 오류

복구:
1. 에러 메시지에서 파일:라인 추출
2. 해당 파일을 Read로 확인
3. 동일 에이전트 재호출 + 에러 메시지를 컨텍스트에 포함
   "이전 시도에서 다음 에러 발생: {에러 메시지}. 수정하세요."
4. 2회 실패 시 → 사용자에게 에러 내용 전달 + 질문
```

### Type B: 테스트 실패
```
감지: unit-tester 결과에 FAIL 포함
증상: assertion 실패, 타임아웃, mock 불일치

복구:
1. 실패한 테스트와 대상 코드를 함께 확인
2. 판단:
   - 테스트가 잘못됨 → unit-tester 재호출 (테스트 수정)
   - 구현이 잘못됨 → 원래 구현 에이전트 재호출 + 실패 내용 컨텍스트
3. 재호출 시 반드시 실패 메시지 포함:
   "테스트 '{테스트명}' 실패. 기대값: {expected}, 실제값: {actual}"
4. 2회 실패 시 → 사용자에게 보고 (다른 접근법 논의)
```

### Type C: 리뷰 실패 (Critical 발견)
```
감지: code-reviewer 결과에 Critical 항목 존재
증상: 보안 취약점, 심각한 설계 결함

복구:
1. Critical 항목의 파일:라인과 수정안 추출
2. 원래 구현 에이전트 재호출 + 리뷰 피드백을 컨텍스트에 포함:
   "code-reviewer가 다음 Critical 이슈를 발견했습니다:
    - {이슈 설명}
    - 수정안: {제안된 수정}
    해당 이슈를 수정하세요."
3. 수정 후 unit-tester → code-reviewer 재실행
4. 2회 연속 같은 Critical → architect 판단 요청
```

### Type D: 아키텍처 거부 (NEEDS_REVISION)
```
감지: architect 결과가 NEEDS_REVISION 또는 REJECTED
증상: 구조적 문제, 확장성 부족

복구:
1. architect의 승인 조건 / 권장사항 추출
2. planner 재호출 + 아키텍처 피드백 컨텍스트:
   "architect가 다음 수정을 요청했습니다: {권장사항}. 계획을 수정하세요."
3. 수정된 계획으로 구현 에이전트 재실행
4. REJECTED인 경우 → 사용자에게 보고 + 대안 제시
```

### Type E: 에이전트 타임아웃/무응답
```
감지: Task 결과가 비정상적으로 짧거나 관련 없는 내용

복구:
1. 작업 범위를 축소하여 재시도 (큰 작업 → 작은 단위로 분할)
2. 컨텍스트가 너무 클 경우 → 핵심만 추려서 재호출
3. 2회 실패 시 → 사용자에게 보고 (executor 대체 여부 확인)
```

### Type F: 파일 충돌
```
감지: 병렬 실행 후 같은 파일이 다르게 수정됨
증상: git conflict 유사 상황

복구:
1. 충돌 파일 식별
2. 양쪽 변경 사항을 Read로 확인
3. architect에게 병합 판단 위임
4. 또는 순차 재실행 (먼저 실행할 에이전트 결정)
```

---

## 복구 흐름 요약

```
에이전트 실패
     │
     ├─ 빌드 에러 (A) ──→ 에러 메시지 + 같은 에이전트 재호출
     ├─ 테스트 실패 (B) ─→ 실패 내용 + 구현/테스트 에이전트 재호출
     ├─ 리뷰 Critical (C) → 리뷰 피드백 + 구현 에이전트 재호출 → 재검증
     ├─ 아키텍처 거부 (D) → 피드백 + planner 재호출 → 재구현
     ├─ 타임아웃 (E) ────→ 범위 축소 재시도
     └─ 파일 충돌 (F) ──→ architect 판단 또는 순차 재실행
```

### Type G: Ralph 루프 연속 실패
```
감지: loop-state.md의 연속 실패 카운터가 3 도달
증상: 같은 이유로 3회 연속 실패 (진전 없음)

복구:
1. 실패 패턴 분석 (같은 에러? 같은 파일?)
2. 자동 중단 + 사용자 보고:
   "3회 연속 같은 이유({이유})로 실패했습니다.
    다른 접근법이 필요합니다."
3. loop-state.md 유지 (재개 가능)
4. 사용자 지시 후 `ralph --resume`으로 재개 가능
5. 또는 autopilot으로 전환 (전문 에이전트 분업)
```

---

## 복구 흐름 요약

```
에이전트 실패
     │
     ├─ 빌드 에러 (A) ──→ 에러 메시지 + 같은 에이전트 재호출
     ├─ 테스트 실패 (B) ─→ 실패 내용 + 구현/테스트 에이전트 재호출
     ├─ 리뷰 Critical (C) → 리뷰 피드백 + 구현 에이전트 재호출 → 재검증
     ├─ 아키텍처 거부 (D) → 피드백 + planner 재호출 → 재구현
     ├─ 타임아웃 (E) ────→ 범위 축소 재시도
     ├─ 파일 충돌 (F) ──→ architect 판단 또는 순차 재실행
     └─ Ralph 연속 실패 (G) → 자동 중단 + 사용자 보고
```

## 공통 규칙

- 재호출 시 **반드시 이전 실패 컨텍스트를 포함**
- **2회 연속 실패** → 사용자에게 보고 + 개입 요청
- 모든 재시도는 **workflow-state.md 재시도 카운터**에 기록
- Ralph 루프 실패는 **loop-state.md 연속 실패 카운터**에 기록
- Critical 보안 이슈는 **즉시 중단** + 보고
